<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breath Buddy - 腹式呼吸練習</title>
    <style>
        /* --- CSS 變數與基本設定 --- */
        :root {
            --ease-out-quart: cubic-bezier(0.165, 0.84, 0.44, 1);
            
            /* 色彩配置 */
            --color-bg-start: #f4f8ff;
            --color-bg-end: #e0eafc;
            --color-circle-start: #89f7fe;
            --color-circle-end: #66a6ff;
            --color-text-primary: #3b4a61;
            --color-text-secondary: #ffffff;
            --color-button-bg: rgba(255, 255, 255, 0.7);
            --color-button-hover-bg: white;
            --color-button-active-bg: #6e8efb;
            --color-button-active-text: white;
            --color-shadow: rgba(110, 142, 251, 0.2);
            --color-focus-ring: #6e8efb;

            /* 圓圈縮放尺寸 */
            --scale-large: 1.25;
            --scale-small: 0.85;
        }

        /* --- 全域樣式 --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end));
            color: var(--color-text-primary);
            text-align: center;
            padding: 1.5rem;
            transition: background 0.5s;
            overflow: hidden;
        }

        /* --- 主要版面與容器 --- */
        .app-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.75rem;
        }
        
        /* --- 標題與說明 --- */
        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.05em;
            color: var(--color-text-primary);
        }
        
        .header p {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 0.5rem;
            line-height: 1.5;
            max-width: 35ch;
            margin-left: auto;
            margin-right: auto;
        }

        /* --- 時長選擇器 (Segmented Control) --- */
        .duration-selector {
            display: flex;
            gap: 0.5rem;
            background-color: var(--color-button-bg);
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: 0 4px 15px var(--color-shadow);
            backdrop-filter: blur(10px);
        }
        .duration-button {
            padding: 0.6rem 1.1rem;
            font-size: 0.9rem;
            border-radius: 50px;
            background-color: transparent;
        }
        .duration-button.active {
            background-color: var(--color-button-active-bg);
            color: var(--color-button-active-text);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(110, 142, 251, 0.4);
        }

        /* --- 呼吸引導圈 --- */
        .breathing-circle-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
        }

        .breathing-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-circle-start), var(--color-circle-end));
            box-shadow: 0 10px 30px var(--color-shadow);
            transform: scale(var(--scale-small)); /* 初始大小 */
            transition-property: transform;
            transition-timing-function: var(--ease-out-quart);
        }
        
        .breathing-circle.state-inhale,
        .breathing-circle.state-hold {
            transform: scale(var(--scale-large));
        }
        
        .breathing-circle.state-exhale,
        .breathing-circle.state-pause {
            transform: scale(var(--scale-small));
        }

        .circle-text-content {
            position: absolute;
            color: var(--color-text-secondary);
            z-index: 10;
            text-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .phase-text {
            font-size: 1.5rem;
            font-weight: 300;
        }
        
        .phase-text.only-child {
            font-size: 2rem;
            font-weight: 400;
        }
        
        .phase-countdown {
            font-size: 3.5rem;
            font-weight: 200;
            line-height: 1;
        }
        
        /* --- 倒數計時 --- */
        .total-countdown-container {
            font-size: 1rem;
            opacity: 0.9;
            background: var(--color-button-bg);
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            min-width: 130px;
        }

        .total-countdown-container span {
            font-weight: 600;
        }
        
        /* --- 控制按鈕 --- */
        .controls {
            display: flex;
            gap: 1rem;
        }
        
        .control-button {
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            background-color: var(--color-button-bg);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--color-shadow);
            backdrop-filter: blur(10px);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            color: var(--color-text-primary);
            font-weight: 500;
        }
        
        .control-button:hover:not(:disabled) {
            background-color: var(--color-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--color-shadow);
        }

        .control-button:focus-visible {
            outline: 3px solid var(--color-focus-ring);
            outline-offset: 3px;
        }

        #start-button, #pause-resume-button, #reset-button {
            width: 50px;
            height: 50px;
            padding: 0;
            font-size: 1.5rem;
            line-height: 50px;
            text-align: center;
        }

        /* --- 完成畫面 --- */
        .completion-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
        }
        .encouragement-message {
            font-size: 1.5rem;
            font-weight: 500;
            color: transparent;
            background-image: linear-gradient(135deg, #6e8efb, #a777e3);
            background-clip: text;
            -webkit-background-clip: text;
            min-height: 2.2rem;
            line-height: 1.4;
        }
        
        /* --- 輔助 & 狀態 --- */
        .hidden {
            display: none !important;
        }

        /* --- 無障礙 & 響應式 --- */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        @media (prefers-reduced-motion: reduce) {
            .breathing-circle, .control-button {
                transition: none !important;
            }
            .control-button:hover {
                transform: none;
            }
        }
        
        @media (max-width: 380px) {
            .app-container {
                gap: 1.5rem;
            }
            .header h1 {
                font-size: 2rem;
            }
            .header p {
                font-size: 0.9rem;
            }
            .breathing-circle-container {
                width: 180px;
                height: 180px;
            }
            .phase-text {
                font-size: 1.2rem;
            }
            .phase-text.only-child {
                font-size: 1.8rem;
            }
            .phase-countdown {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>

    <main class="app-container">
        
        <!-- 設定畫面 -->
        <div id="settings-view">
            <header class="header">
                <h1>Breath Buddy</h1>
                <p>跟隨圓圈進行 4-4-4-1 節奏的腹式呼吸，找回平靜。</p>
            </header>
            <div class="duration-selector" role="radiogroup" aria-labelledby="duration-label">
                <span id="duration-label" class="sr-only">選擇練習總時長</span>
                <button class="control-button duration-button active" data-duration="60" role="radio" aria-checked="true">60 秒</button>
                <button class="control-button duration-button" data-duration="90" role="radio" aria-checked="false">90 秒</button>
                <button class="control-button duration-button" data-duration="120" role="radio" aria-checked="false">120 秒</button>
            </div>
            <div class="controls">
                <button id="start-button" class="control-button" aria-label="開始練習">▶</button>
            </div>
        </div>
        
        <!-- 練習主畫面 -->
        <div id="exercise-view" class="hidden">
            <div class="breathing-circle-container">
                <div id="breathing-circle" class="breathing-circle"></div>
                <div class="circle-text-content">
                    <p id="phase-text" class="phase-text"></p>
                    <p id="phase-countdown" class="phase-countdown"></p>
                </div>
            </div>
            <div class="total-countdown-container">
                剩餘: <span id="total-countdown"></span> 秒
            </div>
            <div class="controls">
                <button id="pause-resume-button" class="control-button" aria-label="暫停練習">⏸</button>
                <button id="reset-button" class="control-button" aria-label="重置練習，返回主畫面">↺</button>
            </div>
        </div>
        
        <!-- 完成畫面 -->
        <div id="completion-view" class="hidden" class="completion-container">
             <header class="header">
                <h1>練習完成</h1>
            </header>
            <p class="encouragement-message" id="encouragement-message"></p>
            <button id="try-again-button" class="control-button" aria-label="再來一次，重新開始相同時長的呼吸練習">再來一次</button>
        </div>

        <!-- 螢幕閱讀器專用的即時更新區域 -->
        <div id="a11y-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM 元素 ---
        const settingsView = document.getElementById('settings-view');
        const exerciseView = document.getElementById('exercise-view');
        const completionView = document.getElementById('completion-view');
        const durationSelector = document.querySelector('.duration-selector');
        const durationButtons = document.querySelectorAll('.duration-button');
        const startButton = document.getElementById('start-button');
        const breathingCircle = document.getElementById('breathing-circle');
        const phaseText = document.getElementById('phase-text');
        const phaseCountdown = document.getElementById('phase-countdown');
        const totalCountdown = document.getElementById('total-countdown');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const resetButton = document.getElementById('reset-button');
        const encouragementMessage = document.getElementById('encouragement-message');
        const tryAgainButton = document.getElementById('try-again-button');
        const a11yLiveRegion = document.getElementById('a11y-live-region');

        // --- 常數設定 ---
        const BEAT_MS = 1000; // 每拍 1 秒

        // 狀態機: 定義呼吸的各個階段
        const PHASES = [
            { name: '吸氣', duration: 4, stateClass: 'state-inhale', hasCountdown: true, beatMs: BEAT_MS },
            { name: '屏息', duration: 4, stateClass: 'state-hold', hasCountdown: true, beatMs: BEAT_MS },
            { name: '呼氣', duration: 4, stateClass: 'state-exhale', hasCountdown: true, beatMs: BEAT_MS },
            { name: '緩息', duration: 1, stateClass: 'state-pause', hasCountdown: false, beatMs: BEAT_MS },
        ];

        const ENCOURAGEMENT_MESSAGES = [
            "做得很好！", "謝謝你給自己這段時間。", "你的專注很珍貴。", "深呼吸讓你更清晰。",
            "你值得這份平靜。", "太棒了，繼續保持。", "今天你已經完成了一件重要的事。",
            "安靜的力量正在滋養你。", "很好，你正在訓練自己的控制力。", "呼吸帶你回到當下。",
            "你的努力正在累積。", "做得真好，身心都更放鬆了。", "這一分鐘，你屬於自己。",
            "你正在慢慢變得更穩定。", "平靜正在你的心裡生根。", "太好了，你已經堅持到了最後。",
            "你的專注令人敬佩。", "這是送給自己的禮物。", "深呼吸，力量就在你心中。",
            "每一次練習都讓你更進步。", "你正在好好照顧自己。", "謝謝你給自己這份溫柔。",
            "平穩的呼吸讓你更堅定。", "很棒，你完成了一次完整的練習。", "你的耐心是最美的力量。",
            "這份寧靜會陪你一整天。", "做得真好，你值得驕傲。", "每一次呼吸都讓你更有能量。",
            "謝謝自己今天的付出。", "你正在成為更專注、更自在的自己。"
        ];

        // --- 狀態變數 ---
        let appState = 'settings'; // 'settings', 'running', 'paused', 'finished'
        let mainTimeout = null;
        let selectedDuration = 60;
        let totalTimeRemaining = selectedDuration;
        let currentPhaseIndex = 0;
        let timeInPhase = 0;

        /**
         * 初始化或重置應用程式狀態與 UI
         */
        function reset() {
            clearTimeout(mainTimeout);
            mainTimeout = null;
            appState = 'settings';
            
            settingsView.classList.remove('hidden');
            exerciseView.classList.add('hidden');
            completionView.classList.add('hidden');

            breathingCircle.style.transitionDuration = '1s';
            breathingCircle.className = 'breathing-circle'; // Reset to default small size
            
            phaseText.textContent = '';
            phaseCountdown.textContent = '';
            totalCountdown.textContent = selectedDuration; // Show selected duration on reset
        }

        /**
         * 處理時長選擇
         * @param {Event} e - 點擊事件
         */
        function handleDurationSelect(e) {
            const button = e.target.closest('.duration-button');
            if (!button || appState !== 'settings') return;

            selectedDuration = parseInt(button.dataset.duration, 10);
            
            durationButtons.forEach(btn => {
                const isActive = btn === button;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-checked', isActive);
            });
        }

        /**
         * 開始練習
         */
        function startExercise() {
            if (appState === 'running') return;
            appState = 'running';
            totalTimeRemaining = selectedDuration;
            
            currentPhaseIndex = -1; // 將從 -1 開始，以便 changePhase() 能正確地從 0 開始
            timeInPhase = 0;

            settingsView.classList.add('hidden');
            completionView.classList.add('hidden');
            exerciseView.classList.remove('hidden');
            
            pauseResumeButton.textContent = '⏸';
            pauseResumeButton.setAttribute('aria-label', '暫停練習');
            
            // 立即進入第一個階段並啟動計時器
            changePhase();
        }

        /**
         * 暫停或繼續練習
         */
        function handlePauseResume() {
            if (appState === 'running') {
                appState = 'paused';
                clearTimeout(mainTimeout);
                pauseResumeButton.textContent = '▶';
                pauseResumeButton.setAttribute('aria-label', '繼續練習');
                a11yLiveRegion.textContent = '練習已暫停。';
            } else if (appState === 'paused') {
                appState = 'running';
                tick(); // 立即執行 tick 以繼續
                pauseResumeButton.textContent = '⏸';
                pauseResumeButton.setAttribute('aria-label', '暫停練習');
                a11yLiveRegion.textContent = '練習已繼續。';
            }
        }
        
        /**
         * 每拍執行的主要邏輯 (Tick)
         */
        function tick() {
            if (appState !== 'running') return;

            // 如果根據上一拍的計時，時間已到，則結束。
            if (totalTimeRemaining <= 0) {
                finish();
                return;
            }

            // 首先，使用當前的狀態值更新所有 UI 元素。
            updateUI(); 

            // 接著，為下一拍準備，更新狀態值。
            totalTimeRemaining--;
            
            const currentBeatMs = PHASES[currentPhaseIndex].beatMs;

            if (timeInPhase > 1) {
                timeInPhase--;
                mainTimeout = setTimeout(tick, currentBeatMs);
            } else {
                // 這是此階段的最後一拍，安排下一拍切換階段。
                mainTimeout = setTimeout(changePhase, currentBeatMs);
            }
        }

        /**
         * 切換到下一個呼吸階段
         */
        function changePhase() {
            currentPhaseIndex = (currentPhaseIndex + 1) % PHASES.length;
            const newPhase = PHASES[currentPhaseIndex];
            timeInPhase = newPhase.duration;
            
            // 設定 CSS transition 時間，確保動畫與階段時間同步
            const transitionSeconds = newPhase.duration * (newPhase.beatMs / 1000);
            breathingCircle.style.transitionDuration = `${transitionSeconds}s`;
            breathingCircle.className = `breathing-circle ${newPhase.stateClass}`;
            
            // 立即啟動下一個 tick
            tick();
        }

        /**
         * 練習完成
         */
        function finish() {
            clearTimeout(mainTimeout);
            appState = 'finished';

            exerciseView.classList.add('hidden');
            completionView.classList.remove('hidden');

            const randomIndex = Math.floor(Math.random() * ENCOURAGEMENT_MESSAGES.length);
            const message = ENCOURAGEMENT_MESSAGES[randomIndex];
            encouragementMessage.textContent = message;
            a11yLiveRegion.textContent = `練習完成。${message}`;
        }
        
        /**
         * 根據目前狀態更新所有可視 UI 元素
         */
        function updateUI() {
            if (appState !== 'running' && appState !== 'paused') return;

            const currentPhase = PHASES[currentPhaseIndex];
            totalCountdown.textContent = totalTimeRemaining;
            phaseText.textContent = currentPhase.name;

            // 根據 "hasCountdown" 決定是否顯示數字
            if (currentPhase.hasCountdown) {
                phaseCountdown.textContent = timeInPhase;
                phaseCountdown.classList.remove('hidden');
                phaseText.classList.remove('only-child');
                 // 為無障礙功能朗讀
                a11yLiveRegion.textContent = `${currentPhase.name} ${timeInPhase}`;
            } else {
                phaseCountdown.textContent = '';
                phaseCountdown.classList.add('hidden');
                phaseText.classList.add('only-child');
                // 為無障礙功能朗讀
                a11yLiveRegion.textContent = currentPhase.name;
            }
        }
        
        // --- 事件監聽器 ---
        durationSelector.addEventListener('click', handleDurationSelect);
        startButton.addEventListener('click', startExercise);
        pauseResumeButton.addEventListener('click', handlePauseResume);
        resetButton.addEventListener('click', reset);
        tryAgainButton.addEventListener('click', startExercise);
        
        // --- 初始執行 ---
        reset(); // 頁面載入時先初始化一次

    });
    </script>
</body>
</html>